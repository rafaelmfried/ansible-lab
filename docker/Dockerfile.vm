FROM debian:13

# Metadados
LABEL maintainer="Rafael Friederick <rafaelmfried@users.noreply.github.com>" \
      description="Ansible VM Simulation - Debian 13 with QEMU/KVM" \
      version="1.0" \
      github="https://github.com/rafaelmfried"

# Variáveis de ambiente
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    LANGUAGE=C.UTF-8 \
    LC_ALL=C.UTF-8

# Instalar QEMU/KVM e ferramentas de virtualização
RUN apt update && \
    apt install -y --no-install-recommends \
        systemd \
        systemd-sysv \
        qemu-kvm \
        qemu-utils \
        qemu-system-x86 \
        libvirt-daemon-system \
        libvirt-clients \
        bridge-utils \
        virtinst \
        ovmf \
        cloud-image-utils \
        openssh-server \
        python3 \
        python3-pip \
        sudo \
        wget \
        curl \
        unzip \
        vim \
        nano \
    && apt clean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# Configurar grupos para KVM
RUN usermod -a -G kvm root

# Criar usuário ansible
RUN groupadd -r ansible && \
    useradd -r -g ansible -G kvm,libvirt -m -d /home/ansible -s /bin/bash ansible && \
    echo 'ansible:ansible' | chpasswd && \
    usermod -aG sudo ansible && \
    echo 'ansible ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Configurar SSH
RUN mkdir -p /var/run/sshd && \
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \
    echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config && \
    echo 'root:ansible' | chpasswd

# Configurar diretórios SSH
RUN mkdir -p /home/ansible/.ssh /root/.ssh && \
    chmod 700 /home/ansible/.ssh /root/.ssh && \
    touch /home/ansible/.ssh/authorized_keys /root/.ssh/authorized_keys && \
    chmod 600 /home/ansible/.ssh/authorized_keys /root/.ssh/authorized_keys && \
    chown -R ansible:ansible /home/ansible/.ssh

# SSH keys serão configuradas via Ansible Vault durante o provisionamento

# Criar diretórios para VMs
RUN mkdir -p /home/ansible/{vms,iso,images} && \
    chown -R ansible:ansible /home/ansible

# Habilitar SSH no systemd
RUN ln -s /lib/systemd/system/ssh.service /etc/systemd/system/multi-user.target.wants/ssh.service

# Ambiente para systemd em container
ENV container=docker

# Expor portas
EXPOSE 22 5900-5910

# Sinal correto para systemd
STOPSIGNAL SIGRTMIN+3

# Comando de inicialização
CMD ["/sbin/init"]
