---
# Playbook para configurar K3s na VM3 com cluster "testcluster"
- name: Configurar K3s cluster "testcluster" na VM3
  hosts: vm3
  vars_files:
    - ../group_vars/all/vault.yml
  vars:
    cluster_name: "testcluster"
    k3s_node_name: "{{ cluster_name }}-master"
    k3s_snapshotter: "native"

  tasks:
    - name: Detectar systemd
      stat:
        path: /run/systemd/system
      register: systemd_present
      changed_when: false
      tags: k3s

    - name: Atualizar cache do apt
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: k3s

    - name: Instalar dependÃªncias para K3s
      become: true
      apt:
        name:
          - curl
          - wget
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
      tags: k3s

    - name: Baixar e instalar K3s (systemd)
      become: true
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_NAME="{{ cluster_name }}" \
        K3S_CONTAINERD_SNAPSHOTTER="{{ k3s_snapshotter }}" \
        K3S_TOKEN="{{ k3s_token }}" \
        K3S_NODE_NAME="{{ k3s_node_name }}" \
        sh -s - server --cluster-init
      args:
        executable: /bin/bash
        creates: /usr/local/bin/k3s
      when: systemd_present.stat.exists
      tags: k3s

    - name: Baixar e instalar K3s (sem systemd)
      become: true
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_NAME="{{ cluster_name }}" \
        INSTALL_K3S_SKIP_ENABLE=true \
        INSTALL_K3S_SKIP_START=true \
        K3S_CONTAINERD_SNAPSHOTTER="{{ k3s_snapshotter }}" \
        K3S_TOKEN="{{ k3s_token }}" \
        K3S_NODE_NAME="{{ k3s_node_name }}" \
        sh -s - server --cluster-init
      args:
        executable: /bin/bash
        creates: /usr/local/bin/k3s
      when: not systemd_present.stat.exists
      tags: k3s

    - name: Iniciar K3s em background (sem systemd)
      become: true
      shell: |
        if [ -f /var/run/k3s.pid ] && kill -0 "$(cat /var/run/k3s.pid)" 2>/dev/null; then
          exit 0
        fi
        nohup /usr/local/bin/k3s server --cluster-init > /var/log/k3s.log 2>&1 &
        echo $! > /var/run/k3s.pid
      args:
        executable: /bin/bash
      environment:
        K3S_TOKEN: "{{ k3s_token }}"
        K3S_NODE_NAME: "{{ k3s_node_name }}"
        K3S_CONTAINERD_SNAPSHOTTER: "{{ k3s_snapshotter }}"
      when: not systemd_present.stat.exists
      tags: k3s

    - name: Aguardar K3s iniciar
      become: false
      wait_for:
        port: 6443
        host: localhost
        delay: 10
        timeout: 300
      tags: k3s

    - name: Aguardar kubeconfig do K3s
      become: true
      wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        timeout: 300
      tags: k3s

    - name: Verificar status do serviÃ§o K3s
      become: true
      systemd:
        name: k3s
        state: started
        enabled: yes
      register: k3s_service_status
      when: systemd_present.stat.exists
      tags: k3s

    - name: Verificar processo do K3s (sem systemd)
      become: true
      shell: |
        if [ -f /var/run/k3s.pid ] && kill -0 "$(cat /var/run/k3s.pid)" 2>/dev/null; then
          echo "running"
        else
          echo "not_running"
        fi
      register: k3s_process_status
      changed_when: false
      when: not systemd_present.stat.exists
      tags: k3s

    - name: Definir status do K3s para exibiÃ§Ã£o
      set_fact:
        k3s_status_display: "{{ k3s_service_status.status.ActiveState }}"
      when: systemd_present.stat.exists
      tags: k3s

    - name: Definir status do K3s para exibiÃ§Ã£o (sem systemd)
      set_fact:
        k3s_status_display: "{{ 'running' if k3s_process_status.stdout == 'running' else 'not_running' }}"
      when: not systemd_present.stat.exists
      tags: k3s

    - name: Obter informaÃ§Ãµes do cluster
      become: true
      shell: |
        KUBECONFIG=/etc/rancher/k3s/k3s.yaml /usr/local/bin/kubectl get nodes
      register: cluster_nodes
      changed_when: false
      tags: k3s

    - name: Obter token do cluster para novos nodes
      become: true
      shell: |
        cat /var/lib/rancher/k3s/server/node-token
      register: cluster_token
      changed_when: false
      tags: k3s

    - name: Exibir informaÃ§Ãµes do cluster testcluster
      become: false
      debug:
        msg: |
          Cluster "{{ cluster_name }}" configurado na {{ inventory_hostname }}
          Status do serviÃ§o: {{ k3s_status_display }}
          Nodes do cluster:
          {{ cluster_nodes.stdout }}
          Token para novos nodes: {{ cluster_token.stdout }}
      tags: k3s

    - name: Criar diretÃ³rio .kube para usuÃ¡rio ansible
      become: true
      file:
        path: /home/ansible/.kube
        state: directory
        owner: ansible
        group: ansible
        mode: "0755"
      tags: k3s

    - name: Criar kubeconfig para usuÃ¡rio ansible
      become: true
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /home/ansible/.kube/config
        remote_src: yes
        owner: ansible
        group: ansible
        mode: "0600"
      tags: k3s

    - name: Verificar se kubectl funciona para usuÃ¡rio ansible
      become: false
      shell: |
        KUBECONFIG=/home/ansible/.kube/config /usr/local/bin/kubectl get nodes
      register: kubectl_test
      changed_when: false
      tags: k3s

    - name: Resultado final
      become: false
      debug:
        msg: |
          âœ… K3s cluster "{{ cluster_name }}" instalado com sucesso!
          ğŸ“ Node: {{ k3s_node_name }}
          ğŸŒ API Server: https://{{ ansible_default_ipv4.address }}:6443
          ğŸ”‘ Kubectl configurado para usuÃ¡rio ansible
          ğŸ“‹ Teste kubectl: {{ kubectl_test.stdout }}
      tags: k3s
