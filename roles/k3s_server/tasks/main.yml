---
- name: Detectar systemd
  stat:
    path: /run/systemd/system
  register: systemd_present
  changed_when: false
  tags: k3s

- name: Validar token do K3s
  assert:
    that:
      - k3s_token is defined
      - k3s_token | length > 0
    fail_msg: "Defina k3s_token em group_vars/all/vault.yml"
  tags: k3s

- name: Garantir diretorio de configuracao do K3s
  become: true
  file:
    path: "{{ k3s_config_dir }}"
    state: directory
    mode: "0755"
  tags: k3s

- name: Definir snapshotter do containerd para o K3s
  become: true
  copy:
    dest: "{{ k3s_config_file }}"
    mode: "0644"
    content: |
      snapshotter: "{{ k3s_snapshotter }}"
  tags: k3s

- name: Atualizar cache do apt
  become: true
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags: k3s

- name: Instalar dependencias para K3s
  become: true
  apt:
    name:
      - curl
      - wget
      - ca-certificates
      - gnupg
      - lsb-release
    state: present
  tags: k3s

- name: Baixar e instalar K3s (systemd)
  become: true
  shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_NAME="{{ cluster_name }}" \
    INSTALL_K3S_EXEC="server --cluster-init --snapshotter {{ k3s_snapshotter }}" \
    K3S_CONFIG_FILE="{{ k3s_config_file }}" \
    K3S_TOKEN="{{ k3s_token }}" \
    K3S_NODE_NAME="{{ k3s_node_name }}" \
    sh -s -
  args:
    executable: /bin/bash
    creates: /usr/local/bin/k3s
  when: systemd_present.stat.exists
  tags: k3s

- name: Baixar e instalar K3s (sem systemd)
  become: true
  shell: |
    curl -sfL https://get.k3s.io | INSTALL_K3S_NAME="{{ cluster_name }}" \
    INSTALL_K3S_SKIP_ENABLE=true \
    INSTALL_K3S_SKIP_START=true \
    INSTALL_K3S_EXEC="server --cluster-init --snapshotter {{ k3s_snapshotter }}" \
    K3S_CONFIG_FILE="{{ k3s_config_file }}" \
    K3S_TOKEN="{{ k3s_token }}" \
    K3S_NODE_NAME="{{ k3s_node_name }}" \
    sh -s -
  args:
    executable: /bin/bash
    creates: /usr/local/bin/k3s
  when: not systemd_present.stat.exists
  tags: k3s

- name: Parar K3s se estiver rodando (sem systemd)
  become: true
  shell: |
    if [ -x /usr/local/bin/k3s-killall.sh ]; then
      /usr/local/bin/k3s-killall.sh || true
    fi
    pkill -f "/usr/local/bin/k3s server" || true
    rm -f /var/run/k3s.pid
  changed_when: false
  failed_when: false
  when: not systemd_present.stat.exists
  tags: k3s

- name: Iniciar K3s em background (sem systemd)
  become: true
  shell: |
    if [ -f /var/run/k3s.pid ] && kill -0 "$(cat /var/run/k3s.pid)" 2>/dev/null; then
      exit 0
    fi
    nohup /usr/local/bin/k3s server --cluster-init --snapshotter {{ k3s_snapshotter }} --config {{ k3s_config_file }} > /var/log/k3s.log 2>&1 &
    echo $! > /var/run/k3s.pid
  args:
    executable: /bin/bash
  environment:
    K3S_TOKEN: "{{ k3s_token }}"
    K3S_NODE_NAME: "{{ k3s_node_name }}"
    K3S_CONFIG_FILE: "{{ k3s_config_file }}"
  when: not systemd_present.stat.exists
  tags: k3s

- name: Aguardar K3s iniciar
  become: false
  wait_for:
    port: "{{ k3s_api_port }}"
    host: localhost
    delay: 10
    timeout: 300
  tags: k3s

- name: Aguardar kubeconfig do K3s
  become: true
  wait_for:
    path: "{{ k3s_kubeconfig }}"
    timeout: 300
  tags: k3s

- name: Aguardar API do K3s responder (best effort)
  become: true
  shell: |
    for i in $(seq 1 {{ k3s_health_retries }}); do
      out="$(/usr/local/bin/kubectl --kubeconfig {{ k3s_kubeconfig }} get --raw='/healthz' 2>/dev/null || true)"
      out="$(printf '%s' "$out" | tr -d '\n')"
      if [ "$out" = "ok" ]; then
        echo "ok"
        exit 0
      fi
      out="$(/usr/local/bin/kubectl --kubeconfig {{ k3s_kubeconfig }} get --raw='/readyz' 2>/dev/null || true)"
      out="$(printf '%s' "$out" | tr -d '\n')"
      if [ "$out" = "ok" ]; then
        echo "ok"
        exit 0
      fi
      sleep {{ k3s_health_delay }}
    done
    echo "not_ready"
    exit 0
  register: k3s_health
  changed_when: false
  tags: k3s

- name: Aviso se API do K3s ainda nao respondeu
  debug:
    msg: "âš ï¸  API do K3s ainda nao respondeu em /healthz. Continuando o playbook..."
  when: k3s_health.stdout is defined and k3s_health.stdout | trim != "ok"
  tags: k3s

- name: Verificar status do servico K3s
  become: true
  systemd:
    name: "{{ k3s_service_name }}"
    state: started
    enabled: yes
  register: k3s_service_status
  when: systemd_present.stat.exists
  tags: k3s

- name: Verificar processo do K3s (sem systemd)
  become: true
  shell: |
    if [ -f /var/run/k3s.pid ] && kill -0 "$(cat /var/run/k3s.pid)" 2>/dev/null; then
      echo "running"
    else
      echo "not_running"
    fi
  register: k3s_process_status
  changed_when: false
  when: not systemd_present.stat.exists
  tags: k3s

- name: Definir status do K3s para exibicao
  set_fact:
    k3s_status_display: "{{ k3s_service_status.status.ActiveState }}"
  when: systemd_present.stat.exists
  tags: k3s

- name: Definir status do K3s para exibicao (sem systemd)
  set_fact:
    k3s_status_display: "{{ 'running' if k3s_process_status.stdout == 'running' else 'not_running' }}"
  when: not systemd_present.stat.exists
  tags: k3s

- name: Obter informacoes do cluster
  become: true
  shell: |
    KUBECONFIG={{ k3s_kubeconfig }} /usr/local/bin/kubectl get nodes
  register: cluster_nodes
  changed_when: false
  retries: 6
  delay: 10
  until: cluster_nodes.rc == 0
  failed_when: false
  tags: k3s

- name: Bootstrap do cluster (dashboard + admin)
  include_tasks: bootstrap.yml
  when: cluster_nodes.rc == 0
  tags: k3s

- name: Verificar se token do cluster existe
  become: true
  stat:
    path: /var/lib/rancher/k3s/server/node-token
  register: k3s_token_file
  changed_when: false
  tags: k3s

- name: Obter token do cluster para novos nodes
  become: true
  shell: |
    cat /var/lib/rancher/k3s/server/node-token
  register: cluster_token
  changed_when: false
  when: k3s_token_file.stat.exists
  failed_when: false
  tags: k3s

- name: Definir saida do cluster para exibicao
  set_fact:
    cluster_nodes_display: "{{ cluster_nodes.stdout if cluster_nodes.rc == 0 else 'API do K3s ainda nao respondeu' }}"
    cluster_token_display: "{{ cluster_token.stdout if (cluster_token is defined and cluster_token.rc == 0) else 'Token ainda indisponivel' }}"
  tags: k3s

- name: Exibir informacoes do cluster
  debug:
    msg: |
      Cluster "{{ cluster_name }}" configurado na {{ inventory_hostname }}
      Status do servico: {{ k3s_status_display }}
      Nodes do cluster:
      {{ cluster_nodes_display }}
      Token para novos nodes: {{ cluster_token_display }}
  tags: k3s

- name: Criar diretorio .kube para usuario ansible
  become: true
  file:
    path: /home/ansible/.kube
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"
  tags: k3s

- name: Criar kubeconfig para usuario ansible
  become: true
  copy:
    src: "{{ k3s_kubeconfig }}"
    dest: "{{ k3s_ansible_kubeconfig }}"
    remote_src: yes
    owner: ansible
    group: ansible
    mode: "0600"
  tags: k3s

- name: Verificar se kubectl funciona para usuario ansible
  become: false
  shell: |
    KUBECONFIG={{ k3s_ansible_kubeconfig }} /usr/local/bin/kubectl get nodes
  register: kubectl_test
  changed_when: false
  tags: k3s

- name: Resultado final
  debug:
    msg: |
      âœ… K3s cluster "{{ cluster_name }}" instalado com sucesso!
      ğŸ“ Node: {{ k3s_node_name }}
      ğŸŒ API Server: https://{{ ansible_default_ipv4.address }}:{{ k3s_api_port }}
      ğŸ”‘ Kubectl configurado para usuario ansible
      ğŸ“‹ Teste kubectl: {{ kubectl_test.stdout }}
  tags: k3s
