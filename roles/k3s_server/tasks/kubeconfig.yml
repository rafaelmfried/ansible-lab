---
- name: Criar diretorio .kube para usuario ansible
  become: true
  file:
    path: /home/ansible/.kube
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"
  tags: k3s

- name: Criar kubeconfig para usuario ansible
  become: true
  copy:
    src: "{{ k3s_kubeconfig }}"
    dest: "{{ k3s_ansible_kubeconfig }}"
    remote_src: yes
    owner: ansible
    group: ansible
    mode: "0600"
  tags: k3s

- name: Verificar se kubectl funciona para usuario ansible
  become: false
  shell: |
    KUBECONFIG={{ k3s_ansible_kubeconfig }} /usr/local/bin/kubectl get nodes
  register: kubectl_test
  changed_when: false
  tags: k3s

- name: Resultado final
  debug:
    msg: |
      âœ… K3s cluster "{{ cluster_name }}" instalado com sucesso!
      ğŸ“ Node: {{ k3s_node_name }}
      ğŸŒ API Server: https://{{ ansible_default_ipv4.address }}:{{ k3s_api_port }}
      ğŸ”‘ Kubectl configurado para usuario ansible
      ğŸ“‹ Teste kubectl: {{ kubectl_test.stdout }}
  tags: k3s
