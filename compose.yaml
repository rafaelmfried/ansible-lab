# Ansible Lab Environment - VMs Básicas
# rafael.friederick@gmail.com

services:
  # ===== VM 01 - FIREWALL (futuro) =====
  vm1:
    build:
      context: .
      dockerfile: docker/Dockerfile.vm
    privileged: true
    cgroup: host
    stop_signal: SIGRTMIN+3
    container_name: vm1
    hostname: vm1
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ansible_ssh_keys:/home/ansible/.ssh:rw
    tmpfs:
      - /run
      - /run/lock
    networks:
      lab_network:
        ipv4_address: 198.18.100.10
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===== VM 02 - KUBERNETES NODES (futuro) =====
  vm2:
    build:
      context: .
      dockerfile: docker/Dockerfile.vm
    privileged: true
    cgroup: host
    stop_signal: SIGRTMIN+3
    container_name: vm2
    hostname: vm2
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ansible_ssh_keys:/home/ansible/.ssh:rw
    tmpfs:
      - /run
      - /run/lock
    networks:
      lab_network:
        ipv4_address: 198.18.100.20
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===== VM 03 - PROXY (futuro) =====
  vm3:
    build:
      context: .
      dockerfile: docker/Dockerfile.vm
    privileged: true
    cgroup: host
    stop_signal: SIGRTMIN+3
    container_name: vm3
    hostname: vm3
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ansible_ssh_keys:/home/ansible/.ssh:rw
    tmpfs:
      - /run
      - /run/lock
    networks:
      lab_network:
        ipv4_address: 198.18.100.30
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===== VM 04 - BASTION (futuro) =====
  vm4:
    build:
      context: .
      dockerfile: docker/Dockerfile.vm
    privileged: true
    cgroup: host
    stop_signal: SIGRTMIN+3
    container_name: vm4
    hostname: vm4
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ansible_ssh_keys:/home/ansible/.ssh:rw
    tmpfs:
      - /run
      - /run/lock
    networks:
      lab_network:
        ipv4_address: 198.18.100.40
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===== VM 05 - POSTGRES (futuro) =====
  vm5:
    build:
      context: .
      dockerfile: docker/Dockerfile.vm
    privileged: true
    cgroup: host
    stop_signal: SIGRTMIN+3
    container_name: vm5
    hostname: vm5
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - ansible_ssh_keys:/home/ansible/.ssh:rw
    tmpfs:
      - /run
      - /run/lock
    networks:
      lab_network:
        ipv4_address: 198.18.100.50
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ===== ANSIBLE CONTROL (OPCIONAL) =====
  # Descomente para usar Ansible Control centralizado
  ansible-control:
    build:
      context: .
      dockerfile: docker/Dockerfile.ansible-control
    privileged: true
    container_name: ansible-control
    hostname: ansible-control
    volumes:
      - ./playbooks:/home/ansible/playbooks:rw
      - ./roles:/home/ansible/roles:rw
      - ./inventory:/home/ansible/inventory:rw
      - ./group_vars:/home/ansible/group_vars:rw
      - ./host_vars:/home/ansible/host_vars:rw
      - ./collections:/home/ansible/collections:rw
      - ./ansible.cfg:/home/ansible/ansible.cfg:ro
      - ansible_ssh_keys:/home/ansible/.ssh:rw
    networks:
      lab_network:
        ipv4_address: 198.18.100.100
    stdin_open: true
    tty: true
    restart: unless-stopped
    ports:
      - 2222:22

networks:
  # Lab Network - Rede única para o laboratório
  lab_network:
    driver: bridge
    ipam:
      config:
        - subnet: 198.18.100.0/24
          gateway: 198.18.100.1

volumes:
  # Volume compartilhado para chaves SSH
  ansible_ssh_keys:
    driver: local
